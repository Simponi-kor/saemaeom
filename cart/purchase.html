<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
        <link rel="stylesheet" href="../css/purchase.css">
            <title>새마음</title>
            <script
                type="text/javascript"
                src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
            <script
                type="text/javascript"
                src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
            <script>
                var IMP = window.IMP; // 생략가능
                IMP.init('imp66833893'); // 'iamport' 대신 부여받은 "가맹점 식별코드"를 사용

                function del_commas(x) {
                    return x.replace(/,/g, "");
                }

                function purchase_btn() {
                    var Bemail = document.getElementById('Uemail');
                    var Bname = document.getElementById('Uname');
                    var Btel = document.getElementById('Uphone');
                    var Baddress = document.getElementById('Uaddress');
                    var first_pname = document.querySelector('.pname');
                    var Bpname = document.getElementById('Upname');
                    var Bprice = document.getElementById('Uprice');
                    var msg;
                    var totalPrice = del_commas(Bprice.value);
                    // console.log(Bpname);

                    IMP.request_pay({
                        pg: 'inicis', // version 1.1.0부터 지원.
                        pay_method: 'card',
                        merchant_uid: 'merchant_' + new Date().getTime(),
                        name: first_pname.innerText + Bpname.value,
                        amount: totalPrice, //판매 가격
                        buyer_email: Bemail.value,
                        buyer_name: Bname.value,
                        buyer_tel: Btel.value,
                        buyer_addr: Baddress.value,
                        buyer_postcode: '123-456'
                    }, function (rsp) {
                        if (rsp.success) {
                            var msg = '결제가 완료되었습니다.';
                            msg += '고유ID : ' + rsp.imp_uid;
                            msg += '상점 거래ID : ' + rsp.merchant_uid;
                            msg += '결제 금액 : ' + rsp.paid_amount;
                            msg += '카드 승인번호 : ' + rsp.apply_num;
                        } else {
                            var msg = '결제에 실패하였습니다.';
                            msg += '에러내용 : ' + rsp.error_msg;
                        }
                        alert(msg);
                    });
                }
            </script>
        </head>
<body>
    <?php
        include("../db/dbcon.php");
        include("../header.html");
        $id=$_SESSION['id'];
        $pro_num = $_POST['check'];
        $pro_num_cnt = COUNT($pro_num);
        $Tprice = $_POST['Tprice'];
        $charge = $_POST['charge'];
        $sql = "SELECT * FROM member where id='$id'";
        $result = $mysqli->query($sql);
        $row = mysqli_fetch_array($result);
    ?>
    <main>
        <input type="hidden" id="Uname" value="<?=$row['name']?>">
        <input type="hidden" id="Uemail" value="<?=$row['email']?>">
        <input type="hidden" id="Uaddress" value="<?=$row['address']?>">
        <input type="hidden" id="Uphone" value="<?=$row['phone']?>"><input type="hidden" id="Upname" value=" 외 <?=$pro_num_cnt-1?> 개">
        <input type="hidden" id="Uprice" value="<?=$Tprice+$charge?>">
        <div class="content">
            <div class="cart_top_text">
                <span class="cart_top">
                    주문결제
                </span>
                <ul class="cart_list">
                    <li>장바구니 ></li>
                    <li style="color:#83dda7;">주문결제 ></li>
                    <li>주문완료</li>
                </ul>
            </div>
            <div class="purchase_main">
                <div class="purchase_left">
                    <div class="purchase_left_box">
                        <div class="purchase_title">
                            <h2>주문고객</h2>
                        </div>
                        <div class="purchase_info">
                            <span class="purchase_info_left">주문자정보</span> <span><?=$row['name']?></span>
                        </div>
                        <div class="purchase_info2">
                            <span class="purchase_info_left">전화</span> <span><?=$row['phone']?></span>
                            <br><br><span class="purchase_info_left"></span>
                            <span>주문, 배송시 등록된 번호로 SNS를 발송해 드립니다</span>
                        </div>
                    </div>
                    <div class="purchase_left_box">
                        <div class="purchase_title">
                            <h2>주소 (배송지)</h2>
                        </div>
                        <div class="info_address">주소</div>
                        <div class="purchase_address">
                            <p><?=$row['address_port']?></p>
                            <p><?=$row['address']?></p>
                            <p><?=$row['address_detail']?></p>
                        </div>
                    </div>
                    <div class="cart">
                        <div class="purchase_title">
                            <h2>주문작품 정보</h2>
                        </div>
                        <ul>
                            <?php
                            for($i=0; $i<$pro_num_cnt; $i++) {
                                $sql = "SELECT cart.cart_num, id, product_num, option_name, product.num, pname, price, marketer, pcategory, achievement, max_achievement, current_achievement, refund, pdate, first_img, content_img, accept FROM cart INNER JOIN  product ON cart.product_num = product.num WHERE cart.cart_num = $pro_num[$i]";
                                $result = $mysqli->query($sql);
                                while($row = mysqli_fetch_array($result)) { ?>
                                    <li>
                                        <div class="cart_img">
                                            <img src="../img/product/<?=$row['first_img']?>" />
                                        </div>
                                        <div class="cart_content">
                                            <div class="cart_left_top">
                                                <div class="cart_content_title">
                                                    <span class="pname"><?=$row['pname']?></span>
                                                </div>
                                                <div class="cart_content_option">
                                                    <span>옵션 : <?=$row['option_name']?></span>
                                                    <div class="cart_content_price">
                                                        <span>수량</span> <span>1</span><span><span><?=number_format($row['price'])?></span> 원</span>
                                                    </div>
                                                </div>
                                                <textarea class="cart_textarea">주문 요청사항을 입력해주세요
                                                </textarea>
                                            </div>
                                        </div>
                                    </li>
                            <?php   }
                            }
                            ?>
                            <!-- <li>
                                <div class="cart_img">
                                    <img src="http://placehold.it/80x80" />
                                </div>
                                <div class="cart_content">
                                    <div class="cart_left_top">
                                        <div class="cart_content_title">
                                            <span>월정리에 조각 조각 모인 유리구슬</span>
                                        </div>
                                        <div class="cart_content_option">
                                            <span>줄 선택 : 베이지</span>
                                            <div class="cart_content_price">
                                                <span>수량</span> <span>2</span><span>24,000 원</span>
                                                <button type="button" class="basic_btn">&times;</button>
                                            </div>
                                        </div>
                                        <textarea class="cart_textarea">주문 요청사항을 입력해주세요
                                        </textarea>
                                    </div>
                                </div>
                            </li> -->
                            <div class="shipping">
                                <span>배송비</span> <span><?=number_format($charge)?>원</span> 
                            </div>
                        </ul>
                    </div>
                </div>
                <div class="purchase_right">
                    <h2>결제 정보</h2>
                    <div class="purchase_right_info">
                        <div>
                            <span class="graycolor">작품금액</span>
                            <span><?=number_format($Tprice)?>원</span>
                        </div>
                        <div>
                            <span class="graycolor">배송비</span>
                            <span><?=number_format($charge)?>원</span>
                        </div>
                        <div>
                            <span class="graycolor">새마음 할인 혜택</span>
                            <span>0원</span>
                        </div>
                    </div>
                    <h4 class="total_price"> <span>최종 결제 금액</span> <span style="font-size: 22pt;"><?=number_format($Tprice+$charge)?>원</span> </h4>
                    <button type="button" class="purchase_btn" onclick="purchase_btn()">결제하기</button>
                </div>
            </div>
            
        </div>
        
    </main>
</body>
</html>